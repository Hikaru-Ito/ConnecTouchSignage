<!DOCTYPE html>
<html>
<head>
    <title>ConnecTouch Signage for ORF2017</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<h1>ConnecTouch FetchTest</h1>

<script>
    const observeReaderId = "192.168.0.202";
    /*1番ラズパイのLinksを監視する*/
    const storedLinks = [];
    /*取得したlinksをローカルの配列として保持する*/

    //差分のみ追加する関数
    const addDiff = (loadedList) => {
        if (storedLinks.length === 0) {
            console.log("pushing");
            loadedList.forEach(item => {
                storedLinks.push(item)
            });
        } else if (storedLinks.length !== loadedList.length) {
            console.log("新しいlinkが追加されました");
            storedLinks.concat(loadedList.slice(storedLinks.length));
            console.log(`storedLinksの件数:${storedLinks.length}`)
        }
    };

    /*ポーリングする関数*/
    const pollingLinks = async () => {
        /*192.168.0.200/linksから紐付いたlinksを取得する*/
        const endPointUrl = `http://192.168.0.200/links?id=${observeReaderId}&limit=100`;
        try {
            const request = await fetch(endPointUrl);
            const loadedList = await request.json();
            // console.log(loadedList);
            addDiff(loadedList);
            if (loadedList.length === 0) {
                console.error(`reader:${observeReaderId}に紐づいたLINKがありません`);
                return false;
            }


            // console.dir(diffList);

        } catch (error) {
            console.log(error)
        }
    };

    /*ポーリングする関数を毎秒呼び出す*/
    const main = () => {
        setInterval(() => {
            pollingLinks();
        }, 1000);
    };

    window.onload = () => {
        main();
    };
</script>
</body>
</html>
